!function(e){"use strict";var n=/@([A-Za-z]+[_A-Za-z0-9]+)/gi;e.jMentions=function(t,o){function a(n,o){var a=e('<div class="'+o+'"></div>');n.length&&(e.jMentions.elm=t,n.forEach(function(n){var t=n[e.jMentions.elm.data("options").value],o=n[e.jMentions.elm.data("options").label],i=n[e.jMentions.elm.data("options").avatar];a.append("<div onclick=\"$(this).jMentions.addMention('"+t+'\')" data-mention="'+t+'"><img src="'+i+'" >'+o+"</div>")}),e("."+e.jMentions.elm.data("options").dropdownClass).remove(),e(t).after(a))}function i(){"SPAN"==window.getSelection().anchorNode.parentNode.tagName&&d.push(window.getSelection().anchorNode.parentNode),"SPAN"==window.getSelection().focusNode.parentNode.tagName&&d.push(window.getSelection().focusNode.parentNode)}function s(){var n=null;if(window.getSelection&&(n=window.getSelection().getRangeAt(0).commonAncestorContainer,n=1===n.nodeType?n:n.parentNode,"SPAN"==n.tagName)){var t=e("<span>").insertAfter(n),o=document.createTextNode("â€‹"),a=t.get(0),i=null,s=null;i=document.createRange(),i.selectNode(a),i.setStartAfter(a),i.insertNode(o),i.setStartAfter(o),s=window.getSelection(),s.removeAllRanges(),s.addRange(i),t.remove()}}var r=e.extend({dropdownClass:"jmentions-dropdown",value:"value",label:"label",avatar:"avatar",source:function(){return{}}},o);e(t).data("options",r);var l,d=[];e.jMentions.getResults=function(n){var o,a=[];if(o=n?e(n).find("span[value]"):e(t).find("span[value]"))for(var i=0;i<o.length;i++)a.indexOf(e(o[i]).attr("value"))==-1&&a.push(e(o[i]).attr("value"));return a},e(t).keyup(function(t){e("."+e(this).data("options").dropdownClass).remove();var o=e(this).text().match(n);if(o){var r=o[0].length,d=e(this).data("options").dropdownClass,c=o[0].slice(1,r);if(e(this).data("options").source(c).promise)e(this).data("options").source(c).promise().done(function(n){a(n,d),e.jMentions.mentions=n});else{var u=e(this).data("options").source(c);a(u,d),e.jMentions.mentions=u}}else e.jMentions.mentions=[];var m=window.getSelection().getRangeAt(0);l&&e(this).html().length<l&&"SPAN"==m.commonAncestorContainer.parentNode.tagName&&e(this)[0].removeChild(m.commonAncestorContainer.parentNode),window.getSelection().toString()?i():s(),l=e(this).html().length}),e(t).keydown(function(n){if(d.length)for(var t=0;t<d.length;t++)e(this)[0].removeChild(d[t]);d=[]}),e(t).mouseup(function(e){window.getSelection().toString()?i():s()})},e.fn.jMentions=function(n){return e.jMentions(this,n)},e.fn.jMentions.addMention=function(t){e.jMentions.mentions.forEach(function(n){t==n[e.jMentions.elm.data("options").value]&&(t=n)});var o=e(e.jMentions.elm),a='&#8203;<span value="'+t[e.jMentions.elm.data("options").value]+'">'+t[e.jMentions.elm.data("options").label]+"</span>&#8203;&nbsp;";o.html(o.html().replace(n,a)),o.click();var i=e("<span />").appendTo(o),s=i.get(0),r=null,l=null;r=document.createRange(),r.selectNode(s),l=window.getSelection(),l.removeAllRanges(),l.addRange(r),i.remove(),e.jMentions.mentions=[],e("."+e.jMentions.elm.data("options").dropdownClass).remove()}}(jQuery);